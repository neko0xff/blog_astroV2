FROM denoland/deno:debian-2.4.5 AS builder

# Setup Environment
WORKDIR /app
ENV NODE_ENV=production

# Setup Project
COPY . .
RUN mkdir -p public/pagefind

# Build Project
RUN deno task install && deno task build

# Find Pages Index
RUN deno task pagefind
RUN ls -la dist/pagefind || echo "Failed to create pagefind index"
RUN if [ -d "dist/pagefind" ]; then \
      cp -r dist/pagefind/* public/pagefind/; \
    else \
      echo "Pagefind index not created properly"; \
      exit 1; \
    fi

# Rebuild Project
RUN deno task build

FROM denoland/deno:alpine-2.4.5
WORKDIR /app

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/deno_prod.json ./deno.json
RUN apk update && apk upgrade
RUN rm -rf /var/cache/apk/*
RUN deno task install
ENV NODE_OPTIONS=--no-warnings


# Service Start
CMD ["task", "service"]

# Listens Serve Port
EXPOSE 8085
